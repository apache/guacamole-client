guacamole-auth-nextcloud
===================

guacamole-auth-nextcloud is an authentication extension for [Apache
Guacamole](http://guacamole.apache.org/) that authenticates users using
a JWT. This token will be generated by the Nextcloud extension [External
sites](https://apps.nextcloud.com/apps/external) and will be sent 
automatically when the Guacamole login page is integrated into your
Nextcloud.

Prepare your Nextcloud
----------------------

Make sure that the [External sites](https://apps.nextcloud.com/apps/external)
plugin is already installed. Use the following [occ](https://docs.nextcloud.com/server/latest/admin_manual/configuration_server/occ_command.html)
command to get the required public key. Remove all line breaks and
comments and add it to your properties file.

    $ occ config:app:get external jwt_token_pubkey_es256

Now you have to add a new website in the plugin settings. There you have
to define a URL, which can look like this:

    https://my-nextcloud.com/guacamole/?nctoken={jwt}

The GET parameter can have any name, by default it is `nctoken`. If you
want to set a different name, you must also set it in the properties file.

Properties
-----------

Property name | Type     | Description
--------------|----------|------------
`nextcloud-jwt-token-name`       | `string` | The key of the GET parameter which contains the JWT token as a value. Default is `nctoken`.
`nextcloud-jwt-allowed-user`     | `string` | An optional list of Nextcloud users who are allowed to open the login page with a valid JWT. Make sure that you use the `uid` and not the displayed name. If the list is empty, all users are allowed, but they still need a valid JWT.
`nextcloud-jwt-public-key`       | `string` | The public key which will be visible with the `occ` command in your Nextcloud instance via the console. Insert the key without line breaks and comments.
`nextcloud-jwt-trusted-networks` | `string` | An optional comma-separated list of permitted IP addresses. An empty list means that all IP addresses are permitted without JWT validation. If the request comes from a trusted network (e.g. local network), the JWT validation will be skipped. The users must authenticate normally with their Guacamole username and password.

Example
-------

      nextcloud-jwt-token-name: mytoken
      nextcloud-jwt-allowed-user: JohnDoe,JaneDoe
      nextcloud-jwt-public-key: MFkwEwYHKoZIzj0....st5CuQ==
      nextcloud-jwt-trusted-networks: 10.8.0.27,10.8.0.41

